{% extends "templates/base.html" %}

{% block content %}
<div x-data="emprestimoForm()">

  <div style="margin-left:16px"><br><h3>{{title}}</h3></div>
  <div class="card-body">
    <form>
      <input type="hidden" x-model="form.emprestimoid" />
      
      <div class="row">
        <div class="col-md-6">
          <label>Cliente</label>
          <select class="form-control" x-model="form.clienteid" x-bind:disabled="disabled">
            <option value="">-- selecione --</option>
            {% for c in clientes %}
              <option value="{{ c.clienteid }}" {% if data and data.clienteid == c.clienteid %}selected{% endif %}>{{ c.nomerazaosocial }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6">
          <label>Livro</label>
          <select class="form-control" x-model="form.livroid" x-bind:disabled="disabled">
            <option value="">-- selecione --</option>
            {% for l in livros %}
              <option value="{{ l.livroid }}" {% if data and data.livroid == l.livroid %}selected{% endif %}>{{ l.titulo }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4 mt-3">
          <label>Valor (R$)</label>
          <input type="number" step="0.01" class="form-control" 
                 x-model="form.valoremprestimo" 
                 x-bind:disabled="disabled">
        </div>

        <div class="col-md-4 mt-3">
          <label>Data Empréstimo</label>
          <input type="date" class="form-control" x-model="form.dataemprestimo" x-bind:disabled="disabled">
        </div>

        <div class="col-md-4 mt-3">
          <label>Data Devolução</label>
          <input type="date" class="form-control" x-model="form.datadevolucao" x-bind:disabled="disabled">
        </div>
      </div>

      <div class="mt-3">
        <button type="button" @click="updateForm()" x-show="!disabled" class="btn btn-primary">Salvar</button>
        <button type="button" @click="deleteForm()" x-show="!disabled" class="btn btn-danger">Remover</button>
        <a href="/emprestimos/ManutEmprestimos" class="btn btn-info ml-2">Retornar</a>
      </div>
    </form>

    <div class="mt-3">
      <template x-if="message">
        <div :class="messageClass" x-text="message"></div>
      </template>
    </div>
  </div>
</div>

<script>
  window.onload = function () { 
    // windowOnLoad(); // Verifique se essa função global existe, senão comente
    const localErro="{{erro}}"; 
    if (localErro!="") alert(localErro); 
  };

  function emprestimoForm() {
    return {
      form: {
        emprestimoid: "{{data.emprestimoid if data else ''}}",
        clienteid: "{{data.clienteid if data else ''}}",
        livroid: "{{data.livroid if data else ''}}",
        
        // --- CORREÇÃO AQUI: Carrega o valor do banco para o formulário ---
        valoremprestimo: "{{data.valoremprestimo if data else ''}}", 
        
        dataemprestimo: "{{data.dataemprestimo if data else ''}}",
        datadevolucao: "{{data.datadevolucao if data else ''}}",
        removido: {{ data.removido | dump | safe if data else false }}
      },
      disabled: {{ disabled }},
      message: '',
      messageClass: '',

      async updateForm() {
        try {
          const response = await fetch('/emprestimos/UpdateEmprestimos', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(this.form) // Agora envia o valoremprestimo junto!
          });
          const result = await response.json();
          if (result.status == "ok") {
            alert("Empréstimo e Financeiro atualizados com sucesso");
            // Opcional: recarregar a página para garantir dados frescos
            // window.location.reload(); 
          } else {
            this.message = `Erro: ${result.msg}`;
            this.messageClass = 'alert alert-danger';
          }
        } catch (error) {
          this.message = `Erro de conexão: ${error.message}`;
          this.messageClass = 'alert alert-danger';
        }
      },

      async deleteForm() {
        if(!confirm("Tem certeza que deseja remover este empréstimo?")) return;
        
        try {
          const response = await fetch('/emprestimos/DeleteEmprestimos', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ emprestimoid: this.form.emprestimoid })
          });
          const result = await response.json();
          if (result.status == "ok") {
            alert("Empréstimo removido com sucesso");
            window.location.href = "/emprestimos/ManutEmprestimos";
          } else {
            this.message = `Erro: ${result.msg}`;
            this.messageClass = 'alert alert-danger';
          }
        } catch (error) {
          this.message = `Erro de conexão: ${error.message}`;
          this.messageClass = 'alert alert-danger';
        }
      }
    };
  }
</script>
{% endblock %}