{% extends "templates/base.html" %}

{% block content %}
<div x-data="livroForm()">
  <ol class="breadcrumb mb-2"><li class="breadcrumb-item active">{{title}}</li></ol>

  <div class="card-header">{{title}}</div>
  <div class="card-body">
    <form>
      <div class="row">
        <div class="col-md-6">
          <label for="titulo">Título</label>
          <input type="text" id="titulo" class="form-control" x-model="form.titulo">
        </div>
        <div class="col-md-6">
          <label for="autor">Autor</label>
          <input type="text" id="autor" class="form-control" x-model="form.autor">
        </div>
        <div class="col-md-3 mt-3">
          <label for="anopublicacao">Ano</label>
          <input type="number" id="anopublicacao" class="form-control" x-model="form.anopublicacao">
        </div>
        <div class="col-md-3 mt-3">
          <label for="genero">Gênero</label>
          <input type="text" id="genero" class="form-control" x-model="form.genero">
        </div>
      </div>

      <button type="button" @click="insertForm()" class="btn btn-primary mt-4">Salvar</button>
      <a href="/livros/ManutLivros" class="btn btn-info mt-4 ml-2">Retornar</a>
    </form>

    <div class="mt-3">
      <template x-if="message">
        <div :class="messageClass" x-text="message"></div>
      </template>
    </div>
  </div>
</div>

<script>
  window.onload = function () { windowOnLoad(); const localErro = "{{erro}}"; if (localErro!="") alert(localErro); };

  function livroForm() {
    return {
      form: { titulo: '', autor: '', anopublicacao: '', genero: '', removido: false },
      message: '', messageClass: '',
      async insertForm() {
        try {
          const response = await fetch('/livros/InsertLivros', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(this.form)
          });
          const result = await response.json();
          if (result.status == "ok") {
            alert("Livro cadastrado com sucesso");
            window.location.href = "/livros/ManutLivros";
          } else {
            this.message = `Erro: ${result.msg}`;
            this.messageClass = 'alert alert-danger';
          }
        } catch (error) {
          this.message = `Erro de conexão: ${error.message}`;
          this.messageClass = 'alert alert-danger';
        }
      }
    };
  }
</script>
{% endblock %}