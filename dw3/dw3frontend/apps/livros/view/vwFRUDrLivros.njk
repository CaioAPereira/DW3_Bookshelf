{% extends "templates/base.html" %}

{% block content %}
<div x-data="livroForm()">
  <ol class="breadcrumb mb-2"><li class="breadcrumb-item active">{{title}}</li></ol>

  <div class="card-header">{{title}}</div>
  <div class="card-body">
    <form>
      <input type="hidden" x-model="form.livroid" />
      <div class="row">
        <div class="col-md-6">
          <label>Título</label>
          <input type="text" class="form-control" x-model="form.titulo" x-bind:disabled="disabled">
        </div>
        <div class="col-md-6">
          <label>Autor</label>
          <input type="text" class="form-control" x-model="form.autor" x-bind:disabled="disabled">
        </div>
        <div class="col-md-3 mt-3">
          <label>Ano</label>
          <input type="number" class="form-control" x-model="form.anopublicacao" x-bind:disabled="disabled">
        </div>
        <div class="col-md-3 mt-3">
          <label>Gênero</label>
          <input type="text" class="form-control" x-model="form.genero" x-bind:disabled="disabled">
        </div>
      </div>

      <div class="mt-3">
        <button type="button" @click="updateForm()" x-show="!disabled" class="btn btn-primary">Salvar</button>
        <button type="button" @click="deleteForm()" x-show="!disabled" class="btn btn-danger">Remover</button>
        <a href="/livros/ManutLivros" class="btn btn-info ml-2">Retornar</a>
      </div>
    </form>

    <div class="mt-3">
      <template x-if="message">
        <div :class="messageClass" x-text="message"></div>
      </template>
    </div>
  </div>
</div>

<script>
  window.onload = function () { windowOnLoad(); const localErro="{{erro}}"; if (localErro!="") alert(localErro); };

  function livroForm() {
    return {
      form: {
        livroid: "{{data.livroid if data else ''}}",
        titulo: "{{data.titulo if data else ''}}",
        autor: "{{data.autor if data else ''}}",
        anopublicacao: "{{data.anopublicacao if data else ''}}",
        genero: "{{data.genero if data else ''}}",
        removido: {{ data.removido | dump | safe if data else false }}
      },
      disabled: {{ disabled }},
      message: '', messageClass: '',

      async updateForm() {
        try {
          const response = await fetch('/livros/UpdateLivros', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(this.form)
          });
          const result = await response.json();
          if (result.status == "ok") {
            alert("Livro atualizado com sucesso");
          } else {
            this.message = `Erro: ${result.msg}`;
            this.messageClass = 'alert alert-danger';
          }
        } catch (error) {
          this.message = `Erro de conexão: ${error.message}`;
          this.messageClass = 'alert alert-danger';
        }
      },

      async deleteForm() {
        try {
          const response = await fetch('/livros/DeleteLivros', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ livroid: this.form.livroid })
          });
          const result = await response.json();
          if (result.status == "ok") {
            alert("Livro removido com sucesso");
            window.location.href = "/livros/ManutLivros";
          } else {
            this.message = `Erro: ${result.msg}`;
            this.messageClass = 'alert alert-danger';
          }
        } catch (error) {
          this.message = `Erro de conexão: ${error.message}`;
          this.messageClass = 'alert alert-danger';
        }
      }
    };
  }
</script>
{% endblock %}